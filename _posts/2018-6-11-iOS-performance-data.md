---
layout:     post
title:      iOS性能数据自动化获取之内存篇  
keywords:   博客
categories: [iOS]
tags:	    [内存，性能测试]
---

APP引入以下API进行二次开发：    
https://github.com/andrealufino/ALSystemUtilities/tree/develop/ALSystemUtilities/ALSystemUtilities   

  ![](/images/images_2018/6-11_1.png)     

优点是：一次获取所有相关性能数据，极大提高专项测试效率；手机无需root；扩展性强，因为是iOS底层API二次开发，APP均可集成使用，集成简单方便；结合自动化脚本执行，可以实现测试自动化闭环，无需手工参与；无门槛，外包同学可使用。数据的准确性有保障（与instrument对比），开发认可。     


## Mac OS内存管理知识     

 ![](/images/images_2018/6-11_4.png)   

### 已使用内存     

10.9以前，已使用内存有三类：     

（1）联动内存：用来存放内核代码和数据结构，主要为内核服务，如负责网络、文件系统之类的。此内存中的信息无法移动到硬盘，不可被压缩，必须保留在RAM中。   

（2）活跃内存：正在被使用或很短时间内被使用过的内存。   

（3）非活跃内存： 最近被使用过，但是目前处于不活跃状态的内存。  

可用内存：未使用的RAM容量，随时可以被应用分配使用。   

虚拟内存大小：所有进程的虚拟内存总量。    

入页面/出页面：指在 RAM 和硬盘之间移动的信息量。将 RAM 中的信息写入硬盘驱动器（因为 RAM 已满）时，即会产生出页面。  

已使用的交换：指拷贝到硬盘驱动器上交换文件中的信息量。  

### Mac OS X非活跃内存释放的顺序      
    
当Free Memory低于某个值时（由物理内存大小决定），系统会按照以下顺序使用Inactive的资源：    
（1）首先，如果Inactive的数据最近被调用了，系统会把它们的状态改变成Active,并且在原有Active内存逻辑地址的后面。   
（2）其次，如果Inactive的内存数据最近没有被使用过，但是曾经被更改过，而还没有在硬盘的相应虚拟[内存]中做修改，系统会对相应硬盘的虚拟内存做修改，并把这部分物理内存释放为free供程序使用。  
（3）再次，如果inactive内存数据被在映射到硬盘后再没有被更改过，则直接释放成free。   
（4）最后如果active的内存一段时间没有被使用，会被暂时改变状态为inactive。   

### 划重点  

当前可用的内存总量= 可用内存 + 非活跃内存    

所以，如果你的系统里有少量的free(可用内存)和大量的inactive(非活跃内存)，说明你的内存是够用的，系统运行在最佳状态，只要需要,系统就会使用它们。   

如果系统的free(可用内存)和inactive(非活跃内存)都很少，而active (活跃内存)很多，说明你的内存不够了。当然一开机，大部分内存都是free,这时系统反而不在最佳状态，因为很多数据都需要从硬盘调用，速度反而慢了。

同时关注出页面也是有必要的。出页面很多可导致性能不好。一般free(可用内存)和inactive(非活跃内存)都很少时，同时也会产生大量的出页面。  

### 已压缩    

 ![](/images/images_2018/6-11_3.png)  

10.9以后，当物理内存已经被占满（大部分非活跃，即文件缓存）后，系统采用的策略是将文件缓存进行压缩，所以能在“已压缩”项目里观察到数据的产生。当文件缓存不可能再被压缩了，系统就选择将部分数据移出页面，就是将数据转移到下一级储存器（即硬盘），这时就产生出页面。

10.8是没有使用压缩技术的，所以当内存被占满后，系统是会将非活跃内存直接移出页面并产生出页面数据，无疑加大I/O的压力。有了内存压缩技术，10.9可以尽可能地将文件缓存到内存，让进程访问这些文件的速度增加。 

文件缓存：这部分为操作系统将硬盘本地文件缓存到内存上的数据，例如某个进程需要读写本地某个文件，那么操作系统内核就会将这个文件缓存到内存上让这个进程访问。   

应用程序内存：这部分是程序运行需要的堆栈内存的总量。    

已使用内存 = 联动内存 + 应用内存 + 已压缩内存 + 已缓存文件  





         

## 产品应用   

以直播类产品为例，性能测试覆盖三个常见用户场景：主播开播、观看直播、观看回放，每个场景执行时间1小时，按照指定频率（比如1s）采集性能数据到文件中，测试结束后观察性能数据曲线图，重点关注APP内存以及系统内存。     

  ![](/images/images_2018/6-11_2.png)   

以上图为例，APP内存有小幅度增加，因为有少许内存泄漏；APP内存中间突然降低，因为产生了内存告警，APP自身处理告警的机制是清除缓存，比如清除放在共享内存中的弹幕；系统内存有几次内存的突增，对应的正是发送豪华礼物的时间点，由于礼物使用系统webview，计算到系统内存里了。发现异常到定位问题，需要结合日志记录系统（了解当时的操作）和工具（Intruments）分析定位到问题的代码行。        

      
扩展阅读：   
iOS 25个性能优化/内存优化常用方法     
https://www.2cto.com/kf/201505/401059.html     

参考文章：   
https://www.jianshu.com/p/fcbb9a472633  
http://elf8848.iteye.com/blog/1373854  
https://bbs.feng.com/read-htm-tid-7202139.html     
https://blog.csdn.net/pizi0475/article/details/53423698   
 
