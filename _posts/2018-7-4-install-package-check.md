---
layout:     post
title:      安装包检查
keywords:   博客
categories: [杂项]
tags:	    [安装包，工具集成]
---

安装包优化一直是APP产品关注的重要指标。随着业务的发展，安装包不可避免的会逐渐膨胀，为了保证用户的下载体验，节省用户带宽，APP开发团队会定期做一些安装包的优化工作。对安装包进行持续监控，及时发现每个版本，甚至每个编译包的变化，能有效得提升安装包的质量。 

## 安装包的组成 

了解安装包的组成，从占比最大的几个部分着手优化可以事半功倍。  

* lib：引用库文件。
* res：包含所有没有被编译到.arsc里面的资源文件
* assets：通常用来存放字体文件、配置数据和web离线包等，它与res的区别见下图 
 ![](/images/images_2018/7-4_01.jpg)  
* class.dex：包含编译后的应用程序源码转化成的dex字节码。APK里，可能存在多个dex文件

## 安装包瘦身原则     

* 清理废弃资源，包括图片、词条和代码等。 
* 将可以延迟下载的组件、资源包从安装包中移除，使用动态加载或下发的方式。
* 资源压缩，比如图片和数据文件压缩等。   

## 具体的检查规则 

* 安装包大小检查。检查安装包体积变化不得超过规定的阀值。iOS端建议选择发布证书+release版本作为被测包，Android端建议选择release版本作为被测包。（开发者证书、企业证书和发布证书打出来的包大小可能不同，debug和release打出的包大小也可能不同）

* 文件大小检查。找出安装包解压后大小超标的文件。各类型文件大小限制（仅供参考，各产品限制不同）：png/gif/jpg 20.0KB，mp4 1.0MB。  

* 重复文件检查（仅资源文件）。首先根据文件头判断文件类型，如果是资源文件，则通过大小和md5值进行是否重复的判断。

* 可压缩图片的检查。尝试对安装包内所有PNG图片进行压缩（不同业务对应不同的压缩算法，常见的包括AdvPNG,JPEGOptim,Jpegtran,Gifsicle等），列出大小可被进一步压缩的文件。 

* 1像素图片检查：检查检查Android安装包xhdpi中的PNG图片尺寸必须大于2x2，否则在小尺寸屏幕机型会缩放为0像素导致crash。

* 1X/2X图片复用检查：找出iPhone安装包中可复用的1x/2x图片，原则上内容相同的图片只保留高分辨率的2x版本即可。

* 针对引入的第三方sdk或者so库的检查。了解sdk和非sdk模块是否存在功能重复的情况，是则需要在非sdk的代码中做删除。限制sdk和so的大小(仅供参考)：so 500.0KB, sdk 100KB。 

* 增加减少so库的检查（Android）。列出本版本增加或减少的so库。 

* 申请权限检查(Android)。对AndroidManifest.xml文件进行检查，包括UsePermisson,Permissoin,UseFeature,LaunchUI,ImageInSvg以及lib字段的变动情况。  

## 检查方法 

* iOS端：使用自动化脚本
* Android端：使用Android Lint检查UnusedResources 


## 安装包监控

将安装包工具集成到平台里，持续监控的意义：
     
 * 保证问题第一时间被发现和尽快修复，能最大化安装包检查工具的价值。   
 * 安装包大小的优化是件长期的工作，需要持续的监控和不断的优化。 

## 流程规范 

将安装包检查结果纳入到发布流程中，可以进一步帮助把控产品质量。   




   

